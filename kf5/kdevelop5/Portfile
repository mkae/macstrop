# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 117140 2014-02-17 15:18:38Z nicos@macports.org $
# Copyright (c) 2015, 2016 R.J.V. Bertin

PortSystem          1.0
PortGroup           muniversal 1.0
PortGroup           compiler_blacklist_versions 1.0
PortGroup           conflicts_build 1.0

set kf5.project     kdevelop
set kf5.virtualPath applications
set kf5.category    development
PortGroup           kf5 1.1

description         KDE/KF5 development IDE.
long_description    KDevelop5 is a free, open source IDE (Integrated \
                    Development Environment) for MS Windows, Mac OS X, \
                    Linux, Solaris and FreeBSD. It is a feature-full, \
                    plugin extensible IDE for C/C++ and other programming \
                    languages. It is based on KDevPlatform, and the KF5 \
                    and Qt libraries and is under development since 1998.
homepage            http://www.kdevelop.org/

platforms           darwin
license             GPL-2+

set PARSER "clang-parser"
subport ${name}-devel {
    description     ${description} This port follows git/master
    long_description \
                    ${long_description} This port follows git/master
}

subport ${name}-${PARSER} {
    description     Clang-based C/C++ parser plugin for KDevelop
    long_description \
                    ${description}
    conflicts-append \
                    ${name}-${PARSER}-devel
}

subport ${name}-${PARSER}-devel {
    description     Clang-based C/C++ parser plugin for KDevelop
    long_description \
                    ${description}
    conflicts-append \
                    ${name}-${PARSER}
}

subport ${name}-translations {
    long_description \
                    This port contains the KDevelop translations.
    depends_run-append \
                    path:bin/kdevelop5:${name}
}

if {${subport} eq "${name}"} {
    conflicts-append \
                    ${name}-devel
    depends_run-append \
                    path:share/kdevclangsupport:${name}-${PARSER}
}

if {${subport} eq "${name}-devel"} {
    conflicts-append \
                    ${name}
    depends_run-append \
                    path:share/kdevclangsupport:${name}-${PARSER}-devel
}

if {(${subport} eq "${name}-${PARSER}") || (${subport} eq "${name}-${PARSER}-devel")} {
    variant system conflicts llvm35 llvm36 llvm37 llvm38 llvm39 description "Use the system LLVM/Clang for the C/C++ parser" {}
    set lldversions {3.6 3.7 3.8 3.9}
    set llvariant ""
    foreach ldv ${lldversions} {
        set llv [join [lrange [split ${ldv} .] 0 1] ""]
        set conflist ""
        foreach v ${lldversions} {
            if {${v} ne ${ldv}} {
                set v [join [lrange [split ${v} .] 0 1] ""]
                set conflist "${conflist} llvm${v}"
            }
        }
        variant llvm${llv} conflicts ${conflist} description "Use LLVM/Clang ${ldv} for the C/C++ parser" {}
        if {[variant_isset llvm${llv}]} {
            set llvariant llvm${llv}
        }
    }
    if {${llvariant} eq "" && ![variant_isset system]} {
        default_variants \
                    +llvm38
    }
    foreach ldv ${lldversions} {
        set llv [join [lrange [split ${ldv} .] 0 1] ""]
        if {[variant_isset llvm${llv}]} {
            depends_lib-append \
                port:llvm-${ldv} port:clang-${ldv}
            configure.args-append \
                -DLLVM_ROOT=${prefix}/libexec/llvm-${ldv}
        }
    }
} elseif {${subport} eq "${name}" || ${subport} eq "${name}-devel"} {
    platform darwin {
        variant gdb description {experimental: build the GDB debugger plugin} {
            depends_run-append \
                    port:gdb
        }
    }
}

# this file is called kdevplatform_version.h in kdevplatform KF5
kf5.require_kf5compat -port kdevelop include/kdevplatform/kdevplatformversion.h

if {(${subport} eq "${name}-devel") || (${subport} eq "${name}-${PARSER}-devel")} {
    fetch.type      git
    git.url     git://anongit.kde.org/kdevelop
# #     v4.90.91-651-gab34bce
#     git.branch      ab34bceb197b9764e29eecbd4fee146a7356faf6
#     v4.90.91-854-g10d6d66
    git.branch      10d6d660015c086ec5b16d4129b2aad6e8f2dfba
    # patch up the trailing git version nr
    version         5.0.3.854
    depends_lib-append \
                    port:kf5-kdevplatform-devel
    worksrcdir      ${name}-5
    distname        ${name}-5
    set PPREFIX     devel
} else {
    version         5.0.3
    use_xz          yes
    set branch      [join [lrange [split ${version} .] 0 1] .]
    use_xz          yes
    master_sites    http://download.kde.org/stable/kdevelop/${version}/src
    distname        ${kf5.project}-${version}
    checksums       rmd160  8010333a6dd53474f1d522e50845639bd0f99ae1 \
                    sha256  17a58dfc38b853c6c5987084e8973b4f7f5015a6c2c20f94c2a9f96b0c13f601
    if {${subport} ne "${name}-translations"} {
        depends_lib-append \
                        path:${kf5.libs_dir}/libKDevPlatformShell.${kf5::libs_ext}:kf5-kdevplatform
        # there is no formal need to disallow building against kf5-kdevplatform-devel, but in practice
        # it turns out to be a good idea not to allow it despite the path:-style dep above.
        conflicts_build-append \
                    port:kf5-kdevplatform-devel
    }
    set PPREFIX     .
}

# port:kdevelop (KDE4) won't build if kf5-kdevplatform is active, but that handicap
# is not mutual. Keep this block as a reminder though.
# conflicts_build-append \
#                     port:kdevplatform \
#                     port:kdevplatform-devel \
#                     port:kdevplatform-git

kf5.depends_qt5_components \
                    qtdeclarative qttools qtwebkit
kf5.depends_frameworks \
                    kcmutils kconfig kdeclarative kdoctools \
                    ki18n kiconthemes kio kitemmodels \
                    kitemviews knewstuff knotifyconfig \
                    kparts kservice ktexteditor \
                    kwindowsystem kxmlgui threadweaver
depends_lib-append  port:kf5-libksysguard

platform darwin {
compiler.blacklist *gcc* {clang < 602} macports-clang-3.3 macports-clang-3.4 macports-clang-3.5
    if {[file exists ${prefix}/bin/clang-mp-3.7]} {
        compiler.whitelist-prepend macports-clang-3.7
    }
    if {[file exists ${prefix}/bin/clang-mp-3.8]} {
        compiler.whitelist-prepend macports-clang-3.8
    }
    if {[file exists ${prefix}/bin/clang-mp-3.9]} {
        compiler.whitelist-prepend macports-clang-3.9
    }
    compiler.fallback-prepend   macports-clang-3.9 macports-clang-3.8 macports-clang-3.7 macports-clang-3.6
}

#Binaries do not link to openssl
license_noconflict  openssl

#Using c++0x for Lion and higher in case of clang 64-bit
if {${configure.compiler} eq "clang" && ${os.platform} eq "darwin" && ${os.major} >= 11} {
    lappend merger_configure_args(x86_64)   -DHAVE_UNORDERED_MAP=1
    if {${build_arch} eq "x86_64" && ![variant_isset universal]} {
        configure.args-append               -DHAVE_UNORDERED_MAP=1
    }
}

pre-configure {
    #Suppress these arguments from cmake portgroup 
    #which break compilation for develop
    configure.args-delete   -DCMAKE_OSX_DEPLOYMENT_TARGET="" \
                            -DCMAKE_OSX_SYSROOT=/
}

# most patchfiles are applied for both subports even if the clang-parser
# port only needs the support4Objc patch. Keep this patch as the 1st in the list!
patchfiles-append   ${PPREFIX}/patch-separate-ide-and-parser.diff

#     patch-cmakeprojects-avoid-crashing.diff no longer needed?
patchfiles-append   patch-missing-header-declbuilder.diff \
                    patch-no-krunner.diff \
                    ${PPREFIX}/patch-rename-kdevexclam.diff \
                    ${PPREFIX}/patch-optlocal-manpages.diff \
                    patch-open-docs-from-Finder.diff \
                    patch-menu-under-x11.diff \
                    patch-cmake-macports-first.diff \
                    ${PPREFIX}/patch-extended-support4Objc.patch
# # https://phabricator.kde.org/D3145
# patchfiles-append   patch-D3145.diff

# replace another Q_ASSERT with a runtime check. Requires kdevplatform:patch-export-iproblem.diff
# https://bugs.kde.org/show_bug.cgi?id=370641
patchfiles-append   patch-clangproblem.diff

# "fix" some known source(s) of beachballing (main thread blocking)
patchfiles-append   patch-prevent-beachballing.diff

platform darwin {
    # on OS X only lldb can be used, so don't build the gdb-based debugging facility
    if {![variant_isset gdb]} {
        if {${subport} eq "${name}-devel" || ${subport} eq "${name}-clang-parser-devel"} {
            patchfiles-append \
                    devel/patch-disable-gdbugger.diff
        } else {
            patchfiles-append \
                    patch-disable-gdbugger.diff
        }
    }
}
platform linux {
    patchfiles-append \
                    patch-binarypath=kdevelop5.diff
}

if {${subport} eq "${name}-devel" || ${subport} eq "${name}-clang-parser-devel"} {
    patchfiles-append \
                    devel/patch-kdevplatform-add-style-menu-uirc.diff
    # https://git.reviewboard.kde.org/r/129416
    patchfiles-append \
                    devel/patch-extra-cmake-settings.diff
    patchfiles-append \
                    devel/patch-cppcheck-location.diff
    post-patch {
        reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/analyzers/cppcheck/parameters.h
    }
} else {
    patchfiles-append \
                    patch-kdevplatform-add-style-menu-uirc.diff
}

# our kdev_format_source has suffix 5
patchfiles-append   patch-kdevformatsource.diff


if {${subport} eq "${name}-translations"} {
    # extract only the translations and CMake stuff
    extract.post_args-append \
                   ${distname}/CMakeLists.txt ${distname}/cmake ${distname}/po
    # NB: we *reset* patchfiles here!
    patchfiles      patch-only-translations.diff
} elseif {${subport} eq ${name} || ${subport} eq "${name}-clang-parser"} {
    patchfiles-append \
                    patch-no-translations.diff
}

if {${subport} ne "${name}-translations"} {
    post-patch {
        reinplace "s|@PREFIX@|${prefix}|g" ${worksrcpath}/projectmanagers/cmake/cmakeutils.cpp
        reinplace "s|/usr/local|${prefix}|g" ${worksrcpath}/projectmanagers/cmake/cmakeutils.cpp
        reinplace "s|/usr/bin/python|${prefix}/bin/python|g" ${worksrcpath}/languages/qmljs/libs/qmljs/parser/changeLicense.py
        foreach p [glob -nocomplain ${worksrcpath}/languages/qmljs/nodejsmodules/*.py] {
            reinplace "s|/usr/bin/python3|${prefix}/bin/python3|g" ${p}
        }
    }
}


if {(${subport} eq "${name}") || (${subport} eq "${name}-devel")} {
    # the build system will check for kdevelop-pg-qt, but the actual dependency appears
    # to be a run-time one on kdev-pg-qt.
    depends_build-append \
                    path:include/kdevelop-pg-qt/kdevelop-pg-qt_version.h:kf5-kdevelop-pg-qt
    # # build dependency on Oxygen is only required when not building with the shipped icon (from Breeze)
    # depends_build-append \
    #                     ${kf5::oxygen-icons_dep}
    depends_run-append \
                    path:bin/kdev-pg-qt:kf5-kdevelop-pg-qt \
                    port:cmake \
                    port:cppcheck

    depends_lib-append \
                    ${kf5::oxygen-icons_dep}

    configure.args-append \
                    -DKDEVELOP_BUILD_IDE=ON \
                    -DKDEVELOP_BUILD_CLANG_PARSER=OFF \
                    -DKDEVELOP_SINGLE_APP=OFF

    variant apidocs description {Generate the API documentation} {}
    if {![variant_isset apidocs]} {
        kf5.allow_apidocs_generation no
    } else {
        default_variants +docs
        kf5.allow_apidocs_generation yes
    }

    patchfiles-append \
                    patch-okteta.diff
    variant okteta description "Adds support for okteta" {
        depends_lib-append  port:kf5-okteta
        patchfiles-delete   patch-okteta.diff
    }
    default_variants \
                    +okteta

    platform darwin {
        variant single_app description {Use QtSingleApplication as the principal class (upstream option)} {
            configure.args-replace \
                    -DKDEVELOP_SINGLE_APP=OFF \
                    -DKDEVELOP_SINGLE_APP=ON
        }

        kf5.kde4compat {
            post-destroot {
                file rename ${destroot}${prefix}/share/doc/HTML/en/kdevelop ${destroot}${prefix}/share/doc/HTML/en/kdevelop5
                file rename ${destroot}${prefix}/share/mime/packages/kdevelop.xml ${destroot}${prefix}/share/mime/packages/kdevelop5.xml
                file delete -force ${destroot}${prefix}/share/icons
            }
        }

        post-destroot {
            # kdevelop is very chatty; protect the system.log when started through LaunchServices:
            move ${destroot}${kf5.applications_dir}/kdevelop.app/Contents/MacOS/kdevelop \
                 ${destroot}${kf5.applications_dir}/kdevelop.app/Contents/MacOS/kdevelop.bin
            xinstall -m 755 -W ${filespath} detach-terminal.sh ${destroot}${kf5.applications_dir}/kdevelop.app/Contents/MacOS/kdevelop
            # install a shortcut in ${prefix}/bin (sic, kdevelop, because on linux we'll build an exec with that name)
            kf5.wrapper_env_additions "KDEV_DISABLE_SPLASH=1"
            kf5.add_app_wrapper kdevelop kdevelop kdevelop.bin
        }
        notes-append "Try adding ${prefix}/bin to the launchctl PATH if KDevelop complains about finding \
            plugins when started through the Finder. For instance: `launchctl setenv PATH \
            \"${prefix}/bin:/usr/bin:/bin:${prefix}/sbin:/usr/sbin:/sbin\"`"
    }

    post-destroot {
        file rename ${destroot}${prefix}/bin/kdevelop ${destroot}${prefix}/bin/kdevelop5
        file rename ${destroot}${prefix}/bin/kdevelop\! ${destroot}${prefix}/bin/kdevelop5\!
    }
} elseif {${subport} eq "${name}-translations"} {
    # nothing to be seen here for now
} else {
    # the clang-based parser component
    if {![info exists BDIR]} {
        set BDIR    ${build.dir}
    }
    kf5.allow_apidocs_generation no

    configure.args-append \
                    -DKDEVELOP_BUILD_IDE=OFF \
                    -DKDEVELOP_BUILD_CLANG_PARSER=ON
    # One can experiment with linking the Xcode libclang via the following additional configure.arg:
    # -DCLANG_LIBCLANG_LIB:FILEPATH=/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/libclang.dylib
}

livecheck.url   http://download.kde.org/stable/kdevelop
