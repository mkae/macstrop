# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$
# Copyright (c) 2015, 2016 R.J.V. Bertin

PortSystem          1.0

# konqueror is a weird one, it lives in the KF5 remnant of kde-baseapps, for a long time as the sole survivor
# Things are moving now (oct 23rd 2016); master has become KF5-only but I am sticking with kf5-baseapps for now.
# set kf5. project     unknown
name                kf5-baseapps
set kf5.virtualPath applications
set kf5.category    utilities
PortGroup           kf5 1.1

maintainers         @RJVB mk openmaintainer

description         Provides kfind and konqueror, a web browser aka universal viewer aka file manager for KF5.
long_description    This port provides KFind (KDE's file find utility) and Konqueror, one of the most advanced file \
                    managers for KDE. Thanks to the underlying KDE technologies it can transparently \
                    access FTP and SFTP servers, zip files (and other archives), smb (Windows) \
                    shares, and even browse and rip audio CDs. \
                    Konqueror is powered by the KHTML rendering engine (and \
                    optionally QtWebEngine) which means it supports the latest web standards such as \
                    HTML5, Javascript, CSS3, and others. \
                    Konqueror makes use of the latest KDE technologies to \
                    provide you with a PDF viewer, an FTP client, a text editor, a spreadsheet \
                    editor, a word document editor, an SVN client and more without ever needing to \
                    open a separate application.
homepage            http://www.konqueror.org/

subport ${name}-devel {
    description     ${description} This port follows git/frameworks, and is very much alpha quality.
    long_description \
                    ${long_description} This port follows git/frameworks, and is very much alpha quality.
}

if {${subport} eq "${name}-devel"} {
    conflicts       ${name}
    fetch.type      git
    if {[file exists ${filespath}/${name}-git/.git]} {
        git.url     ${filespath}/${name}-git
    } else {
        git.url     git://anongit.kde.org/kde-baseapps
    }
# #     v16.07.80-1657-gbfd09bc
#     git.branch      bfd09bcec03e8080bfce33f850c54bcff3a4a475
#     v16.07.80-1719-gc5bd2d6
    git.branch      c5bd2d667b4baa4f241eef09870e3c1ba3159649
    version         16.07.80.1719
} else {
    conflicts       ${name}-devel
    description     ${description} This port doesn't have a release version yet.
    long_description \
                    ${long_description} This port doesn't have a release version yet.
    version         0
    use_xz          yes
    pre-fetch {
        ui_error "This port doesn't have a release version yet."
        return -code error "This port doesn't have a release version yet."
    }
    checksums       rmd160  0 \
                    sha256  0
}

worksrcdir          ${name}-5
distname            ${name}-5

# conflicts

kf5.depends_qt5_components \
                    qtdeclarative qtlocation qtscript \
                    qtwebchannel qtwebengine

kf5.depends_frameworks \
                    kactivities karchive kbookmarks kcmutils \
                    kconfig kconfigwidgets kcoreaddons kcrash \
                    kdbusaddons kded kdelibs4support kdesu \
                    khtml ki18n kiconthemes kinit kio \
                    kjobwidgets kwidgetsaddons
kf5.depends_build_frameworks \
                    oxygen-icons
depends_lib-append  port:tidy \
                    port:zlib
depends_run-append  port:kf5-kio-extras

kf5.allow_docs_generation no

patch.pre_args      -Np1
patchfiles-append   patch-preserve-window-icon.diff \
                    patch-plugin-paths.diff \
                    patch-add-app-icon.diff \
                    patch-rename-libs.diff \
                    patch-nongui-executables.diff \
                    patch-konq-plugins-validators-tidy_validator.cpp.diff
patchfiles-append   patch-exclude-netwmh.diff \
                    patch-select-apps.diff

post-patch {
    reinplace "s|<binary>konqueror</binary>|<binary>konqueror5</binary>|g" ${worksrcpath}/konqueror/org.kde.konqueror.appdata.xml
}

platform darwin {
    kf5.kde4compat -port kde4-baseapps {
        post-destroot {
            file rename ${destroot}${prefix}/bin/kfmclient ${destroot}${prefix}/bin/kfmclient5
            file rename ${destroot}${prefix}/share/doc/HTML/en/kfind ${destroot}${prefix}/share/doc/HTML/en/kfind5
            file delete ${destroot}${prefix}/share/appdata/kfind.appdata.xml
            file delete ${destroot}${prefix}/share/appdata/konqueror.appdata.xml
            file delete ${destroot}${prefix}/share/config.kcfg/keditbookmarks.kcfg
            file delete ${destroot}${prefix}/share/config.kcfg/konqueror.kcfg
            file delete ${destroot}${prefix}/share/config.kcfg/validators.kcfg
            file delete ${destroot}${prefix}/share/dbus-1/interfaces/org.kde.Konqueror.Main.xml
            file delete ${destroot}${prefix}/share/dbus-1/interfaces/org.kde.Konqueror.MainWindow.xml
            file delete ${destroot}${prefix}/share/dbus-1/interfaces/org.kde.kdialog.ProgressDialog.xml
            file delete ${destroot}${prefix}/share/dbus-1/interfaces/org.kde.konqueror.Preloader.xml
            file delete -force ${destroot}${prefix}/share/icons/oxygen
            # there's 1 icon we provide that no one else installs, so we have to be selective:
            foreach i {konqueror kfind fsview} {
                foreach j [glob -nocomplain ${destroot}${prefix}/share/icons/hicolor/*/apps/${i}.png] {
                    file delete -force ${j}
                }
            }
            file delete -force ${destroot}${prefix}/share/man
        }
    }
    post-destroot {
        kf5.add_app_wrapper konqueror5 konqueror
        kf5.add_app_wrapper kfind5 kfind
    }
}
platform linux {
    post-destroot {
        kf5.add_app_wrapper konqueror5 konqueror
    }
}
post-destroot {
    reinplace "s|Exec=konqueror |Exec=konqueror5 |g" ${destroot}${prefix}/share/kservices5/org.kde.konqueror.desktop
}
