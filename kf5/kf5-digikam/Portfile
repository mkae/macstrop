# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$
# Copyright (c) 2015, 2016 R.J.V. Bertin

PortSystem          1.0

set kf5.project     digikam
set kf5.virtualPath applications
set kf5.category    graphics
PortGroup           kf5 1.1
PortGroup           active_variants 1.1
PortGroup           conflicts_build 1.0

kf5.use_latest      kf5.release
revision            2

maintainers         gmail.com:rjvbertin mk openmaintainer

description         Photo Management Programme.
long_description    Digital photo management programme to import, organise, enhance, search and export your digital images.
homepage            http://www.digikam.org/

subport ${name}-devel {
    description     ${description} This port follows git/frameworks
    long_description \
                    ${long_description} This port follows git/frameworks
}

if {${subport} eq "${name}-devel"} {
    conflicts       ${name}
    fetch.type      git
    if {[file exists ${filespath}/${kf5.project}-git/.git]} {
        git.url     ${filespath}/${kf5.project}-git
    } else {
        git.url     git://anongit.kde.org/digikam
    }
# #     v5.1.0-133-gccb8f1c
#     git.branch      ccb8f1c4d2f8bdd34a4390c6b521700c122c1cff
#     v5.2.0-100-g9f08606
    git.branch      9f08606952582930edcb785febad347db12bfbab
    version         5.2.0.100
    distname        ${kf5.project}-5
    worksrcdir      ${kf5.project}-5
    patch.pre_args  -Np2
    set srcdir      .
} else {
    conflicts       ${name}-devel
    version         5.2.0
    use_xz          yes
    checksums       rmd160  a8c9dfa64bdd97291764d95b09197f418c826fce \
                    sha256  cf243fc1518b5bb6e289573c76d89b5fdcc50be89f6312b276af3320763c9260
    master_sites    http://download.kde.org/stable/digikam/
    distname        ${kf5.project}-${version}
    patch.pre_args  -Np1
    set srcdir      core
}

# sadly this port isn't compatible with KDE4's digikam
conflicts-append    digikam

kf5.depends_qt5_components \
                    qtmultimedia qtwebkit

depends_lib-append \
                    path:include/KF5/libkipi_version.h:kf5-libkipi \
                    port:kf5-kcalcore

kf5.depends_frameworks \
                    kconfig kcoreaddons ki18n kiconthemes \
                    kio kservice kwindowsystem kxmlgui solid
#optional
kf5.depends_frameworks \
                    kbookmarks kfilemetadata kitemmodels \
                    knotifications knotifyconfig threadweaver

depends_lib-append  port:opencv
require_active_variants opencv qt5
require_active_variants opencv contrib

platform darwin {
    depends_build-append \
                    port:flex \
                    port:bison

    depends_lib-append \
                    port:libpgf \
                    port:tiff \
                    port:jpeg \
                    port:libpng \
                    port:kf5-marble

    # Dependencies of kipi-plugins

    depends_lib-append \
                    port:expat\
                    port:gdk-pixbuf2 \
                    port:libgpod \
                    port:libxml2 \
                    port:libxslt \
                    port:ImageMagick \
                    path:include/eigen3/Eigen/Eigen:eigen3

    # Dependencies of digiKam

    depends_lib-append \
                    port:lcms2 \
                    port:boost \
                    path:lib/pkgconfig/glib-2.0.pc:glib2 \
                    port:lensfun \
                    port:libgphoto2 \
                    port:gphoto2 \
                    port:liblqr \
                    port:libusb \
                    port:jasper \
                    port:kf5-libkexiv2

    # RunTime dependencies

    depends_run-append \
                    path:share/icons/oxygen/index.theme:oxygen-icons \
                    path:${qt_plugins_dir}/sqldrivers/libqsqlite.${qt_libs_ext}:qt5-sqlite-plugin \
                    port:gstreamer1-gst-libav \
                    port:gstreamer1-gst-plugins-good
} else {
    # elsewhere we take as much as possible from the system
    depends_lib-append \
                    port:tiff \
                    port:jpeg \
                    port:kf5-marble

    # Dependencies of kipi-plugins

    depends_lib-append \
                    port:expat\
                    port:libxml2 \
                    port:libxslt

    # Dependencies of digiKam

    depends_lib-append \
                    port:libgphoto2 \
                    port:gphoto2 \
                    port:jasper \
                    port:exiv2 \
                    port:kf5-libkexiv2
    # digikam currently doesn't link when exiv2 is built with XMP support
    require_active_variants exiv2 "" xmp
}

kf5.allow_docs_generation no

# # https://git.reviewboard.kde.org/r/128732/
# patchfiles-append   patch-reenable-styles.diff

if {${subport} eq "${name}"} {
    # https://bugs.kde.org/show_bug.cgi?id=368965
    # to be incorporated in 5.3.0
    patchfiles-append \
                    patch-tableview-fix.diff
}

if {![variant_isset nativeQSP]} {
    configure.args-append \
                    -DENABLE_APPSTYLES=ON \
}

configure.args-append \
                    -DENABLE_KFILEMETADATASUPPORT=ON \
                    -DENABLE_OPENCV3=ON \
                    -DENABLE_MEDIAPLAYER=ON
platform linux {
    configure.args-append \
                    -DBUILD_TESTING=OFF
}

# Optional compilation options #############################################

# Option to include debug symbols in compiled target

if {[variant_isset debug]} {
    configure.args-append -DCMAKE_BUILD_TYPE=debugfull
}

# Option to compile handbook

if {[variant_isset docs]} {
    configure.args-append -DDIGIKAMSC_COMPILE_DOC=on
} else {
    configure.args-append -DDIGIKAMSC_COMPILE_DOC=off
}

# Option to check MySQL availability before compiling target

set use_msql            no
configure.args-append   -DENABLE_INTERNALMYSQL=off -DENABLE_MYSQLSUPPORT=off

variant mysql_check conflicts mariadb description {Check MySQL availability before building digiKam} {
    configure.args-delete  -DENABLE_INTERNALMYSQL=off -DENABLE_MYSQLSUPPORT=off
    configure.args-append  -DENABLE_INTERNALMYSQL=on -DENABLE_MYSQLSUPPORT=on
    platform darwin {
        depends_lib-append  path:bin/mysql_config5:mysql5
    }
    set use_msql            yes
}
variant mariadb conflicts mysql_check description {Use MariaDB instead of MySQL} {
    configure.args-delete   -DENABLE_INTERNALMYSQL=off -DENABLE_MYSQLSUPPORT=off
    configure.args-append   -DENABLE_INTERNALMYSQL=on -DENABLE_MYSQLSUPPORT=on
    platform darwin {
        depends_lib-append  port:mariadb
    }
    configure.env-append    MYSQLD_PATH=${prefix}/lib/mariadb/bin MYSQL_TOOLS_PATH=${prefix}/lib/mariadb/bin
    set use_msql            yes
}

# post-destroot {
#     if {${use_msql}} {
#         ln -s digikamdatabaseserver.app/Contents/MacOS/digikamdatabaseserver ${destroot}${prefix}/libexec/kde5/digikamdatabaseserver
#     }
# }

post-patch {
    if {[file exists ${worksrcpath}/${srcdir}/cmake/modules/modules_opencv/FindOpenCV.cmake]} {
        reinplace "s|/usr/local|${prefix}|g" ${worksrcpath}/${srcdir}/cmake/modules/modules_opencv/FindOpenCV.cmake
    }
    if {${prefix} ne "/opt/local"} {
        # Digikam already has provisions for "standard MacPorts install"s; make it more generic
        reinplace "s|/opt/local/|${prefix}/|g" ${worksrcpath}/${srcdir}/libs/database/utils/dbsettingswidget.cpp \
            ${worksrcpath}/${srcdir}/libs/dimg/filters/icc/iccprofile.cpp \
            ${worksrcpath}/${srcdir}/utilities/setup/setupicc.cpp \
            ${worksrcpath}/${srcdir}/utilities/assistants/expoblending/importwizard/expoblendingintropage.cpp \
            ${worksrcpath}/${srcdir}/utilities/assistants/panorama/importwizard/panointropage.cpp
    }
    platform linux {
        reinplace "s|/usr/local/|${prefix}/|g" ${worksrcpath}/${srcdir}/libs/database/utils/dbsettingswidget.cpp \
            ${worksrcpath}/${srcdir}/libs/dimg/filters/icc/iccprofile.cpp \
            ${worksrcpath}/${srcdir}/utilities/setup/setupicc.cpp \
            ${worksrcpath}/${srcdir}/utilities/assistants/expoblending/importwizard/expoblendingintropage.cpp \
            ${worksrcpath}/${srcdir}/utilities/assistants/panorama/importwizard/panointropage.cpp
    }
}

# digikam's build system is particularly slow, so use the install/fast target which
# is acceptable the build phase should have be completed successfully anyway once
# the destroot phase is started.
destroot.target     install/fast

post-destroot {
    platform darwin {
        kf5.add_app_wrapper digikam5 digikam
    } else {
        file rename ${destroot}${prefix}/bin/digikam ${destroot}${prefix}/bin/digikam.bin
        kf5.add_app_wrapper digikam digikam.bin
        kf5.add_app_wrapper digikam5 digikam.bin
    }
}

livecheck.url       http://download.kde.org/stable/digikam
livecheck.regex     \\-(\\d+\\.\\d+\\.\\d)
