# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem      1.0

name                kchmviewer
version             7.7

# subport kf5-${name} {}


if {${subport} eq "kf5-${name}"} {
    set kf5.dont_use_xz 1
    PortGroup       kf5 1.1
    set kf5.category development
    description     A CHM (Winhelp) files viewer written for Qt/KF5.
    long_description \
                    kchmviewer is a reader for CHM (Winhelp) and EPUB \
                    files using the Qt toolkit with KDE support. \
                    The main point of kchmviewer is compatibility with \
                    non-English chm files, including most international charsets.
} else {
    PortGroup       qmake5 1.0
    categories      kde devel
    description     A CHM (Winhelp) files viewer written for Qt.
    long_description \
                    kchmviewer is a reader for CHM (Winhelp) and EPUB \
                    files using the Qt toolkit. \
                    The main point of kchmviewer is compatibility with \
                    non-English chm files, including most international charsets.
}

maintainers         gmail.com:rjvbertin mk openmaintainer
platforms           darwin linux
license             GPL-3

homepage            sourceforge:kchmviewer
distname            ${name}-${version}
master_sites        sourceforge:project/${name}/${name}/${version}

checksums           rmd160  3b072a3225c5a4c796a9406232c3f696285d9aa4 \
                    sha256  27cbac45c786b1718550a87e6f86010e161302b426c6396ff2a3091b913b17dd

depends_build-append \
                    port:dos2unix

depends_lib-append  port:libzip \
                    port:chmlib

qt5.depends_component \
                    qtwebkit

post-extract {
    system -W ${worksrcpath} "find . \\\( -name \"*.cpp\" -o -name \"*.h\" -o -name \"*.pro\" \\\) -exec dos2unix '{}' \";\""
}

patch.pre_args      -Np1
patchfiles-append   patch-release-build.diff \
                    patch-libzip-incpath.diff \
                    patch-use-webkit-and-dbus.diff \
                    patch-avoid-private-member.diff \
                    patch-main-mac.diff \
                    patch-encoding-no-abort.diff

post-patch {
    reinplace "s|@PREFIX@|${prefix}|g" \
                    ${worksrcpath}/lib/libebook/libebook.pro \
                    ${worksrcpath}/src/src.pro
}

if {${subport} eq "${name}"} {
    configure.cppflags-append   -I${prefix}/lib/libzip/include
    default configure.dir       {${workpath}/build}
    configure.pre_args-append   ../${worksrcdir}/${name}.pro
    configure.args-append       -nocache -recursive
    default build.dir           {${workpath}/build}
}

platform darwin {
    destroot {
        xinstall -m 755 -d ${destroot}${qt_apps_dir}
        file copy ${build.dir}/bin/kchmviewer.app ${destroot}${qt_apps_dir}
        if {[info procs qt5.add_app_wrapper] ne ""} {
            qt5.add_app_wrapper kchmviewer
        }
    }
}

platform linux {
    destroot {
        xinstall -m 755 ${build.dir}/bin/kchmviewer ${destroot}${prefix}/bin
    }
}

livecheck.regex /${name}-(\[0-9.\]+)${extract.suffix}
