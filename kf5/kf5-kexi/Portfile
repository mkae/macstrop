# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id$
# Copyright (c) 2015, 2016 R.J.V. Bertin

PortSystem          1.0

set kf5.project     kexi
set kf5.virtualPath applications
set kf5.category    office
PortGroup           kf5 1.1

maintainers         gmail.com:rjvbertin mk openmaintainer
version             3.0.0

conflicts           calligra

patch.pre_args      -Np1

proc setup_compilers {} {
    global prefix
    platform darwin {
        compiler.blacklist *gcc* {clang < 602} macports-clang-3.3 macports-clang-3.4 macports-clang-3.5
        if {[file exists ${prefix}/bin/clang-mp-3.7]} {
            compiler.whitelist-prepend macports-clang-3.7
        }
        if {[file exists ${prefix}/bin/clang-mp-3.8]} {
            compiler.whitelist-prepend macports-clang-3.8
        }
        if {[file exists ${prefix}/bin/clang-mp-3.9]} {
            compiler.whitelist-prepend macports-clang-3.9
        }
        compiler.fallback-prepend   macports-clang-3.9 macports-clang-3.8 macports-clang-3.7 macports-clang-3.6
    }
}

subport kf5-kdb {
    description     KDb is a database connectivity and creation framework for various database vendors.
    long_description \
                    KDb consists of a general-purpose C++/Qt-only library and a set of plugins. \
                    Unlike QtSQL, KDb 'knows' how to create database and new tables. It has a Qt/C++ API for that. \
                    KDb aims to be a next generation database handling layer for Kexi and similar complex apps.
    kf5.set_project kdb
    homepage        https://community.kde.org/KDb
    master_sites    http://download.kde.org/stable/${kf5.project}/src
    distname        ${kf5.project}-${version}
    checksums       rmd160  db0f959789f5128aeac4d0b544e73eebbf129d20 \
                    sha256  b7dcc4f90a6adf069faa725bb2182639b59ff4f570f7fd1b790c3012c68913a0
    depends_lib-append \
                    port:sqlite3
    kf5.depends_frameworks \
                    kcoreaddons ki18n
    patchfiles-append \
                    kdb/patch-kdb-mac-tweaks.diff
    variant mariadb description {support MySql through port:mariadb} {
        depends_lib-append \
                    port:mariadb
        configure.args-append \
                    -DPC_MYSQL_INCLUDEDIR=${prefix}/include/mariadb/mysql \
                    -DPC_MYSQL_LIBDIR=${prefix}/lib/mariadb/mysql
    }
    variant postgresql93 description {support PostgreSQL through port:postgresql93} {
        depends_lib-append \
                    port:postgresql93
        # PostgreSQL support doesn't have a dedicated token for finding the library
        configure.args-append \
                    -DPC_LIBPQ_INCLUDE_DIRS="${prefix}/include/postgresql93\;${prefix}/include/postgresql93/server\;${prefix}/lib/postgresql93"
    }
    setup_compilers
}

subport kf5-kpropertywidgets {
    description     A property editing framework with editor widget.
    long_description \
                    ${description}
    kf5.set_project kproperty
    homepage        http://community.kde.org/KProperty
    master_sites    http://download.kde.org/stable/${kf5.project}/src
    distname        ${kf5.project}-${version}
    checksums       rmd160  d982cf0f907c1a34dfd4c89cadc864e384ac40b5 \
                    sha256  86cd24007d6b313a0217e4a0a7e4b594f46b3fc2d2d4aee2db1d14fdf16b0e99
    kf5.depends_frameworks \
                    kconfig kcoreaddons kguiaddons ki18n kwidgetsaddons
}

subport kf5-kreport {
    description     A framework for the creation and generation of reports in multiple formats.
    long_description \
                    The KReport framework implements reporting functionality for creation \
                    of reports in MS Access style. They are also similar to SAP Crystal Reports \
                    and FileMaker reports.
    kf5.set_project kreport
    homepage        http://community.kde.org/KReport
    master_sites    http://download.kde.org/stable/${kf5.project}/src
    distname        ${kf5.project}-${version}
    checksums       rmd160  9c01f5e5e8c7ca30962d84af86b4e564f54d6964 \
                    sha256  c3d8a310fd4b68bbce83370796ea2efdf93b9ce9f8cafb66e331b0db94ec2a00
    kf5.depends_qt5_components \
                    qtdeclarative
    kf5.depends_frameworks \
                    kconfig kcoreaddons kguiaddons ki18n kwidgetsaddons
    depends_lib-append \
                    port:kf5-kpropertywidgets
    variant qtwebkit description {build the web plugin} {
        kf5.depends_qt5_components \
                    qtwebkit
    }
    if {![variant_isset qtwebkit]} {
        post-patch {
            reinplace "s|find_package(Qt5WebKitWidgets|# find_package(Qt5WebKitWidgets|g" \
                    ${worksrcpath}/src/plugins/CMakeLists.txt
        }
    }
    variant maps description {build the maps plugin} {
        depends_lib-append \
                    port:kf5-marble
    }
    if {![variant_isset maps]} {
        post-patch {
            reinplace "s|find_package(Marble|# find_package(Marble|g" \
                    ${worksrcpath}/src/plugins/CMakeLists.txt
        }
    }
}

subport kf5-kexi {
    description     Kexi
    categories-append databases
    homepage        http://www.kexi-project.org/
    master_sites    http://download.kde.org/stable/${kf5.project}/src
    distname        ${kf5.project}-${version}
    checksums       rmd160  d473efafe8dfc0a4973dab57aa6298ed73a41473 \
                    sha256  8acfdf9f933139544aa8a8f53b04f5266c1cec6b3844963d04404e8b7f72ffe0
    kf5.allow_apidocs_generation no
    depends_build-append \
                    port:kf5-breeze-icons
    depends_lib-append \
                    port:libiconv
    platform darwin {
        depends_lib-append \
                    path:lib/libglib-2.0.dylib:glib2
    }
    kf5.depends_frameworks \
                    karchive kcodecs kcompletion kconfig \
                    kconfigwidgets kcoreaddons kcrash kguiaddons \
                    ki18n kiconthemes kitemviews kio \
                    ktexteditor ktextwidgets kwidgetsaddons kxmlgui
    depends_lib-append \
                    port:kf5-kdb \
                    port:kf5-kpropertywidgets
    # no need to do a complicated check if the Breeze icons are really there
    # also deactivate the default search for Marble and QtWebKit
    patchfiles-append \
                    kexi/patch-kexi-cmakelists-tweaks.diff
    # fix the add_app_icon logic
    # https://commits.kde.org/kexi/0bf2adee61da2d5e1efe0431478acc26da6c033d
    patchfiles-append \
                    kexi/patch-kexi-app-icon.diff
    # https://commits.kde.org/kexi/a04ceadaebbe33227becc0146fd0d9a54b72656a
    patchfiles-append \
                    kexi/patch-build-en-handbook.diff
    # force the Fusion application style for this one
    patchfiles-append \
                    kexi/patch-kexi-force-fusion.diff
    if {[variant_isset docs]} {
        configure.args-append \
                    -DSHOULD_BUILD_DOC=ON
    }
    variant mariadb description {support MySql through port:mariadb} {
        depends_lib-append \
                    port:mariadb
        configure.args-append \
                    -DPC_MYSQL_INCLUDEDIR=${prefix}/include/mariadb/mysql \
                    -DPC_MYSQL_LIBDIR=${prefix}/lib/mariadb/mysql
    }
    variant postgresql93 description {support PostgreSQL through port:postgresql93} {
        depends_lib-append \
                    port:postgresql93
        # PostgreSQL support doesn't have a dedicated token for finding the library
        configure.args-append \
                    -DPostgreSQL_ADDITIONAL_SEARCH_PATHS="${prefix}/include/postgresql93\;${prefix}/include/postgresql93/server\;${prefix}/lib/postgresql93"
    }
    variant qtwebkit description {build the web plugin} {
        kf5.depends_qt5_components \
                    qtwebkit
        post-patch {
            reinplace "s|#QWK find_package(Qt5 |find_package(Qt5 |g" \
                    ${worksrcpath}/CMakeLists.txt
        }
    }
    variant maps description {build the maps plugin} {
        depends_lib-append \
                    port:kf5-marble
        post-patch {
            reinplace "s|# find_package(KexiMarble|find_package(KexiMarble|g" \
                    ${worksrcpath}/CMakeLists.txt
        }
    }
    setup_compilers
    post-destroot {
        kf5.add_app_wrapper kexi5 kexi
    }
}

livecheck.url       http://download.kde.org/stable/${kf5.project}/src
livecheck.regex     \\-(\\d+\\.\\d+\\.\\d)
